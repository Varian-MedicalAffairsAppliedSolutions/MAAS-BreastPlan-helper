name: Build ESAPI Script - v15.6

on:
  workflow_dispatch:
    inputs:
      dateInput:
        description: 'Expiration Date'
        required: true
        default: '7/11/2023'

jobs:
  build:
    runs-on: windows-2022
    env:
      GITHUB_WORKSPACE_PACKAGES_PATH: packages\ESAPI.15.6.0\lib\net45\
      PROJECT_NAME: MAAS-BreastPlan-helper
      MAJOR_VERSION: 2
      MINOR_VERSION: 5
      PATCH_VERSION: 6
      BUILD_NUMBER: ${{ github.run_number }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install .NET Framework 4.5 Targeting Pack
      run: |
        Write-Host "Installing .NET Framework 4.5 Developer Pack..."
        $url = "https://download.microsoft.com/download/2/F/6/2F63CCD8-9288-4CC8-B58C-81D109F8F5A3/NDP452-KB2901907-x86-x64-AllOS-ENU.exe"
        $output = "$env:TEMP\NDP452-KB2901907-x86-x64-AllOS-ENU.exe"
        
        # Download .NET Framework 4.5.2 (includes 4.5 targeting)
        Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
        
        # Install silently
        Start-Process -FilePath $output -ArgumentList "/quiet" -Wait -NoNewWindow
        
        Write-Host ".NET Framework 4.5 targeting components installed successfully"

    - name: Navigate to Workspace
      run: cd $GITHUB_WORKSPACE

    - name: Update AssemblyInfo.cs
      id: update_assembly_info
      run: |
        .\.github\workflows\Update-AssemblyInfo.ps1 `
          -AssemblyInfoFilePath .\Properties\AssemblyInfo.cs `
          -ExpirationDate "${{ github.event.inputs.dateInput }}" `
          -MajorVersion ${{ env.MAJOR_VERSION }} `
          -MinorVersion ${{ env.MINOR_VERSION }} `
          -PatchVersion ${{ env.PATCH_VERSION }} `
          -BuildNumber ${{ env.BUILD_NUMBER }}

    - name: Setup NuGet.exe for use with actions
      uses: NuGet/setup-nuget@v1
      with:
        nuget-version: latest
    
    - name: Download nuget packages
      run: nuget install .\packages.config -OutputDirectory packages

    - name: Add VIC GitHub NuGet repository
      run: nuget source add
        -Name github `
        -Source "https://nuget.pkg.github.com/Varian-MedicalAffairsAppliedSolutions/index.json" `
        -UserName craman96 `
        -Password ${{ secrets.GITHUB_TOKEN }} `
        -StorePasswordInClearText

    - name: Download nuget package
      run: nuget install ESAPI -Version 15.6.0 -OutputDirectory packages

    - name: Update hint paths in the csproj file
      run: |
        .\.github\workflows\Update-EsapiHintPaths.ps1 `
        -CsprojFilePath .\ `
        -CsprojFileName MAAS-BreastPlan-helper.csproj

    - name: Build Solution
      run: msbuild.exe .\MAAS-BreastPlan-helper.csproj /nologo /nr:false /p:DeleteExistingFiles=True /p:platform="x64" /p:configuration="Debug"
        
    - name: Zip
      run: |
        Compress-Archive `
          -Path ".\bin\Debug\*" `
          -DestinationPath "${{ github.workspace }}/${{env.PROJECT_NAME}}${{ steps.update_assembly_info.outputs.RELEASE_FILE_NAME }}-EclipseV156.zip"
    
    - name: Create Release
      uses: softprops/action-gh-release@v0.1.13
      with:
        name: ${{env.PROJECT_NAME}}${{ steps.update_assembly_info.outputs.RELEASE_NAME }}-EclipseV15.6
        tag_name: ${{env.PROJECT_NAME}}${{ steps.update_assembly_info.outputs.RELEASE_NAME }}-EclipseV15.6
        token: ${{ secrets.GITHUB_TOKEN }}
        draft: false
        prerelease: false
        body: |
          This is an official release of the **`${{ env.PROJECT_NAME }}`** project.
          Supported Eclipse version: `v15.6`.
          The generated dll is valid until `${{ github.event.inputs.dateInput }}`.
        files: ${{ github.workspace }}/${{env.PROJECT_NAME}}${{ steps.update_assembly_info.outputs.RELEASE_FILE_NAME }}-EclipseV156.zip
